# Laf å®Œæ•´é…ç½®æŒ‡å—

## ğŸ¸ ä»€ä¹ˆæ˜¯ Lafï¼Ÿ

Laf æ˜¯**å›½äº§ç‰ˆ Firebase**ï¼Œæä¾›ï¼š
- â˜ï¸ äº‘å‡½æ•° (ç±»ä¼¼ Firebase Functions)
- ğŸ—„ï¸ MongoDB æ•°æ®åº“ (ç±»ä¼¼ Firestore)
- ğŸ” è®¤è¯ç³»ç»Ÿ
- ğŸ“¦ å¯¹è±¡å­˜å‚¨ (ç±»ä¼¼ Storage)
- ğŸš€ å›½å†…è®¿é—®é€Ÿåº¦æå¿«

---

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œ Laf è´¦å·

### 1. è®¿é—®å®˜ç½‘
æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š**https://laf.run**

### 2. ç‚¹å‡»"å…è´¹ä½¿ç”¨"
- é€‰æ‹©æ‰‹æœºå·æ³¨å†Œæˆ–å¾®ä¿¡æ‰«ç 
- **æ¨è**ï¼šä½¿ç”¨æ‰‹æœºå·ï¼ˆ+86ï¼‰

### 3. å¡«å†™ä¿¡æ¯
- è¾“å…¥æ‰‹æœºå·
- è¾“å…¥éªŒè¯ç 
- è®¾ç½®å¯†ç ï¼ˆå»ºè®®ç”¨å¼ºå¯†ç ï¼‰

### 4. å®Œæˆæ³¨å†Œ
æ³¨å†ŒæˆåŠŸåä¼šè‡ªåŠ¨è·³è½¬åˆ°æ§åˆ¶å°

---

## ğŸš€ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºåº”ç”¨

### 1. è¿›å…¥æ§åˆ¶å°
ç‚¹å‡»å³ä¸Šè§’ **"åˆ›å»ºåº”ç”¨"**

### 2. å¡«å†™åº”ç”¨ä¿¡æ¯
- **åº”ç”¨åç§°**ï¼š`xianyu-calculator` æˆ–ä»»æ„åç§°
- **é€‰æ‹©åŒºåŸŸ**ï¼š
  - ğŸ”¥ **æ­å·** (æ¨èï¼Œé˜¿é‡Œäº‘èŠ‚ç‚¹ï¼Œé€Ÿåº¦å¿«)
  - åŒ—äº¬ (è…¾è®¯äº‘èŠ‚ç‚¹)
  - ä¸Šæµ·
- **è§„æ ¼**ï¼šé€‰æ‹© **å…è´¹ç‰ˆ**ï¼ˆè¶³å¤Ÿå°å‹é¡¹ç›®ä½¿ç”¨ï¼‰

### 3. åˆ›å»º

ç‚¹å‡»"åˆ›å»º"ï¼Œç­‰å¾… 10-30 ç§’

### 4. è·å–è®¿é—®åœ°å€
åˆ›å»ºæˆåŠŸåï¼Œæ‚¨ä¼šçœ‹åˆ°ï¼š
- **åº”ç”¨åœ°å€**ï¼š`https://your-app-name.laf.run`
- è¿™å°±æ˜¯æ‚¨çš„**æµ‹è¯•åŸŸå**ï¼Œå¯ä»¥ç«‹å³ä½¿ç”¨ï¼

---

## ğŸ—„ï¸ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ•°æ®åº“é›†åˆ

### 1. è¿›å…¥æ•°æ®åº“ç®¡ç†
åœ¨å·¦ä¾§èœå•ç‚¹å‡» **"æ•°æ®åº“"**

### 2. åˆ›å»º Users é›†åˆ
1. ç‚¹å‡» **"æ–°å»ºé›†åˆ"**
2. é›†åˆåç§°ï¼š`users`
3. ç‚¹å‡»"ç¡®å®š"

### 3. åˆ›å»º Messages é›†åˆ
é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œåˆ›å»º `messages` é›†åˆ

### 4. (å¯é€‰) æ·»åŠ ç´¢å¼•
- ç‚¹å‡» `users` é›†åˆ
- ç‚¹å‡» **"ç´¢å¼•"** æ ‡ç­¾
- æ·»åŠ ç´¢å¼•ï¼š
  - å­—æ®µï¼š`email`
  - ç±»å‹ï¼š**å”¯ä¸€ç´¢å¼•**ï¼ˆé˜²æ­¢é‡å¤æ³¨å†Œï¼‰

---

## â˜ï¸ ç¬¬å››æ­¥ï¼šåˆ›å»ºäº‘å‡½æ•°

### 1. è¿›å…¥äº‘å‡½æ•°ç¼–è¾‘å™¨
å·¦ä¾§èœå•ç‚¹å‡» **"äº‘å‡½æ•°"**

### 2. åˆ›å»ºæ³¨å†Œå‡½æ•° `user-register`

ç‚¹å‡» **"æ–°å»º"**ï¼Œå¡«å†™ï¼š
- **å‡½æ•°åç§°**ï¼š`user-register`
- **æè¿°**ï¼šç”¨æˆ·æ³¨å†Œ

ä»£ç å¦‚ä¸‹ï¼ˆå…ˆå¤åˆ¶ç²˜è´´ï¼Œåé¢ä¼šè¯¦ç»†è®²è§£ï¼‰ï¼š

```javascript
import cloud from '@lafjs/cloud'

export async function main(ctx: FunctionContext) {
  const { email, password, nickname } = ctx.body
  
  // 1. å‚æ•°éªŒè¯
  if (!email || !password) {
    return { code: 400, message: 'é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º' }
  }
  
  // 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
  const db = cloud.database()
  const existUser = await db.collection('users').where({ email }).getOne()
  if (existUser.data) {
    return { code: 400, message: 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ' }
  }
  
  // 3. åŠ å¯†å¯†ç 
  const bcrypt = require('bcrypt')
  const hashedPassword = await bcrypt.hash(password, 10)
  
  // 4. åˆ›å»ºç”¨æˆ·
  const result = await db.collection('users').add({
    email: email,
    password: hashedPassword,
    nickname: nickname || email.split('@')[0],
    avatarUrl: '',
    createdAt: new Date(),
    updatedAt: new Date()
  })
  
  // 5. ç”Ÿæˆ Token
  const token = cloud.getToken({
    uid: result.id,
    email: email
  })
  
  return {
    code: 0,
    message: 'æ³¨å†ŒæˆåŠŸ',
    data: {
      token: token,
      user: {
        uid: result.id,
        email: email,
        nickname: nickname || email.split('@')[0]
      }
    }
  }
}
```

**ç‚¹å‡»å³ä¸Šè§’"ä¿å­˜"å¹¶"å‘å¸ƒ"**

### 3. å®‰è£…ä¾èµ–ï¼ˆbcryptï¼‰
1. ç‚¹å‡»å·¦ä¾§ **"ä¾èµ–ç®¡ç†"**
2. æœç´¢ï¼š`bcrypt`
3. ç‚¹å‡»"æ·»åŠ "
4. ç­‰å¾…å®‰è£…å®Œæˆï¼ˆçº¦1åˆ†é’Ÿï¼‰

### 4. åˆ›å»ºç™»å½•å‡½æ•° `user-login`

å†æ¬¡ç‚¹å‡» **"æ–°å»º"**ï¼š
- **å‡½æ•°åç§°**ï¼š`user-login`

ä»£ç ï¼š

```javascript
import cloud from '@lafjs/cloud'

export async function main(ctx: FunctionContext) {
  const { email, password } = ctx.body
  
  // 1. å‚æ•°éªŒè¯
  if (!email || !password) {
    return { code: 400, message: 'é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º' }
  }
  
  // 2. æŸ¥è¯¢ç”¨æˆ·
  const db = cloud.database()
  const user = await db.collection('users').where({ email }).getOne()
  
  if (!user.data) {
    return { code: 404, message: 'ç”¨æˆ·ä¸å­˜åœ¨' }
  }
  
  // 3. éªŒè¯å¯†ç 
  const bcrypt = require('bcrypt')
  const isMatch = await bcrypt.compare(password, user.data.password)
  
  if (!isMatch) {
    return { code: 401, message: 'å¯†ç é”™è¯¯' }
  }
  
  // 4. ç”Ÿæˆ Token
  const token = cloud.getToken({
    uid: user.data._id,
    email: email
  })
  
  return {
    code: 0,
    message: 'ç™»å½•æˆåŠŸ',
    data: {
      token: token,
      user: {
        uid: user.data._id,
        email: user.data.email,
        nickname: user.data.nickname,
        avatarUrl: user.data.avatarUrl
      }
    }
  }
}
```

**ä¿å­˜å¹¶å‘å¸ƒ**

### 5. åˆ›å»ºè·å–ç”¨æˆ·ä¿¡æ¯å‡½æ•° `user-info`

```javascript
import cloud from '@lafjs/cloud'

export async function main(ctx: FunctionContext) {
  // 1. ä» Token è·å–ç”¨æˆ·ID
  const user = ctx.user
  if (!user) {
    return { code: 401, message: 'æœªç™»å½•' }
  }
  
  // 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
  const db = cloud.database()
  const userInfo = await db.collection('users')
    .where({ _id: user.uid })
    .getOne()
  
  if (!userInfo.data) {
    return { code: 404, message: 'ç”¨æˆ·ä¸å­˜åœ¨' }
  }
  
  // ä¸è¿”å›å¯†ç 
  delete userInfo.data.password
  
  return {
    code: 0,
    data: userInfo.data
  }
}
```

**ä¿å­˜å¹¶å‘å¸ƒ**

### 6. åˆ›å»ºç•™è¨€æ¿æŸ¥è¯¢å‡½æ•° `messages-list`

```javascript
import cloud from '@lafjs/cloud'

export async function main(ctx: FunctionContext) {
  const db = cloud.database()
  
  // æŸ¥è¯¢æ‰€æœ‰ç•™è¨€ï¼ŒæŒ‰æ—¶é—´å€’åº
  const messages = await db.collection('messages')
    .orderBy('timestamp', 'desc')
    .limit(100)
    .get()
  
  return {
    code: 0,
    data: messages.data
  }
}
```

### 7. åˆ›å»ºå‘å¸ƒç•™è¨€å‡½æ•° `message-add`

```javascript
import cloud from '@lafjs/cloud'

export async function main(ctx: FunctionContext) {
  const { content, imageUrl } = ctx.body
  const user = ctx.user
  
  // 1. éªŒè¯ç™»å½•
  if (!user) {
    return { code: 401, message: 'è¯·å…ˆç™»å½•' }
  }
  
  // 2. è·å–ç”¨æˆ·ä¿¡æ¯
  const db = cloud.database()
  const userInfo = await db.collection('users')
    .where({ _id: user.uid })
    .getOne()
  
  // 3. åˆ›å»ºç•™è¨€
  const now = new Date()
  const result = await db.collection('messages').add({
    userId: user.uid,
    userName: userInfo.data.nickname,
    userAvatar: userInfo.data.avatarUrl,
    content: content || '',
    imageUrl: imageUrl || '',
    timestamp: now,
    displayTime: now.toLocaleString('zh-CN')
  })
  
  return {
    code: 0,
    message: 'å‘å¸ƒæˆåŠŸ',
    data: result.id
  }
}
```

**ä¿å­˜å¹¶å‘å¸ƒ**

### 8. åˆ›å»ºå¯†ç é‡ç½®å‡½æ•° `send-password-reset`

```javascript
import cloud from '@lafjs/cloud'

export async function main(ctx: FunctionContext) {
  const { email } = ctx.body
  
  if (!email) {
    return { code: 400, message: 'é‚®ç®±ä¸èƒ½ä¸ºç©º' }
  }
  
  // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  const db = cloud.database()
  const user = await db.collection('users').where({ email }).getOne()
  
  if (!user.data) {
    return { code: 404, message: 'è¯¥é‚®ç®±æœªæ³¨å†Œ' }
  }
  
  // 2. ç”Ÿæˆé‡ç½® Tokenï¼ˆæœ‰æ•ˆæœŸ1å°æ—¶ï¼‰
  const resetToken = cloud.getToken({
    uid: user.data._id,
    type: 'password-reset'
  }, 3600)  // 1å°æ—¶è¿‡æœŸ
  
  // 3. æ„å»ºé‡ç½®é“¾æ¥
  const resetLink = `https://your-app.laf.run/reset-password?token=${resetToken}`
  
  // 4. å‘é€é‚®ä»¶ (ä½¿ç”¨ Resend)
  const { Resend } = require('resend')
  const resend = new Resend('re_4tWgh2hj_6qwqn2gwUBKg38JEpmE31WSu')
  
  const { data, error } = await resend.emails.send({
    from: 'Zaoyoe <noreply@zaoyoe.com>',
    to: email,
    subject: 'é‡ç½®æ‚¨çš„å¯†ç ',
    html: `
      <!DOCTYPE html>
      <html>
      <body style="font-family: Arial, sans-serif; padding: 20px;">
        <h2>é‡ç½®å¯†ç </h2>
        <p>æ‚¨å¥½ï¼Œ</p>
        <p>æˆ‘ä»¬æ”¶åˆ°äº†æ‚¨é‡ç½®å¯†ç çš„è¯·æ±‚ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å®Œæˆé‡ç½®ï¼š</p>
        <a href="${resetLink}" style="display: inline-block; background: #9b5de5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; margin: 20px 0;">ç«‹å³é‡ç½®å¯†ç </a>
        <p>æ­¤é“¾æ¥å°†åœ¨ 1 å°æ—¶åå¤±æ•ˆã€‚</p>
        <p>å¦‚æœæ‚¨æ²¡æœ‰è¯·æ±‚é‡ç½®å¯†ç ï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚</p>
      </body>
      </html>
    `
  })
  
  if (error) {
    return { code: 500, message: 'é‚®ä»¶å‘é€å¤±è´¥: ' + error.message }
  }
  
  return {
    code: 0,
    message: 'é‡ç½®å¯†ç é‚®ä»¶å·²å‘é€'
  }
}
```

**ä¿å­˜å¹¶å‘å¸ƒ**

ç„¶åæ·»åŠ  `resend` ä¾èµ–ï¼š
- ä¾èµ–ç®¡ç† â†’ æœç´¢ `resend` â†’ æ·»åŠ 

---

## ğŸ¨ ç¬¬äº”æ­¥ï¼šå‰ç«¯è¿ç§»

### 1. å®‰è£… Laf SDK

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š

```bash
npm install laf-client-sdk
```

(å¦‚æœæ²¡æœ‰ npmï¼Œå¯ä»¥å…ˆè·³è¿‡ï¼Œç›´æ¥ç”¨ CDN)

### 2. åˆ›å»º Laf åˆå§‹åŒ–æ–‡ä»¶

åˆ›å»ºæ–°æ–‡ä»¶ `/Volumes/chao/AI/xianyu_profit_calculator/laf-init.js`:

```javascript
// Laf åˆå§‹åŒ–é…ç½®
import { Cloud } from 'laf-client-sdk'

// æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åº”ç”¨åœ°å€
const cloud = new Cloud({
  baseUrl: 'https://YOUR-APP-NAME.laf.run',  // âš ï¸ æ›¿æ¢è¿™é‡Œï¼
  dbProxyUrl: '/proxy/db',
  getAccessToken: () => localStorage.getItem('laf_token')
})

// å…¨å±€å¯¼å‡º
window.lafCloud = cloud

// è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
window.checkLoginStatus = async function() {
  const token = localStorage.getItem('laf_token')
  if (!token) return null
  
  try {
    const res = await cloud.invoke('user-info')
    if (res.code === 0) {
      return res.data
    }
  } catch (e) {
    localStorage.removeItem('laf_token')
  }
  return null
}

console.log('Laf SDK åˆå§‹åŒ–å®Œæˆ')
```

### 3. åœ¨ HTML å¼•å…¥

ä¿®æ”¹ `index.html`ï¼Œ**ç§»é™¤ Firebase SDK**ï¼Œæ·»åŠ  Lafï¼š

æ‰¾åˆ° `<head>` åŒºåŸŸï¼Œåˆ é™¤æ‰€æœ‰ Firebase ç›¸å…³çš„ `<script>` æ ‡ç­¾ï¼Œæ›¿æ¢ä¸ºï¼š

```html
<!-- Laf SDK -->
<script type="module" src="./laf-init.js"></script>
```

---

## ğŸ”„ ç¬¬å…­æ­¥ï¼šæ”¹å†™å‰ç«¯ä»£ç 

### æ³¨å†ŒåŠŸèƒ½æ”¹å†™

**åŸ Firebase ä»£ç ** (script.js çº¦ 600è¡Œ)ï¼š
```javascript
const userCredential = await window.createUserWithEmailAndPassword(
  window.firebaseAuth,
  email,
  password
);
```

**æ–° Laf ä»£ç **ï¼š
```javascript
const result = await window.lafCloud.invoke('user-register', {
  email: email,
  password: password,
  nickname: nickname
});

if (result.code === 0) {
  localStorage.setItem('laf_token', result.data.token);
  localStorage.setItem('cached_user_profile', JSON.stringify(result.data.user));
  // æ³¨å†ŒæˆåŠŸé€»è¾‘...
} else {
  alert('æ³¨å†Œå¤±è´¥: ' + result.message);
}
```

### ç™»å½•åŠŸèƒ½æ”¹å†™

**åŸä»£ç **ï¼š
```javascript
await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
```

**æ–°ä»£ç **ï¼š
```javascript
const result = await window.lafCloud.invoke('user-login', {
  email: email,
  password: password
});

if (result.code === 0) {
  localStorage.setItem('laf_token', result.data.token);
  localStorage.setItem('cached_user_profile', JSON.stringify(result.data.user));
  // ç™»å½•æˆåŠŸ...
} else {
  alert('ç™»å½•å¤±è´¥: ' + result.message);
}
```

### ç•™è¨€æ¿åŠ è½½æ”¹å†™

**åŸä»£ç **ï¼š
```javascript
const q = query(collection(db, 'messages'), orderBy('timestamp', 'desc'));
const querySnapshot = await getDocs(q);
```

**æ–°ä»£ç **ï¼š
```javascript
const result = await window.lafCloud.invoke('messages-list');
if (result.code === 0) {
  const messages = result.data;
  // å¤„ç†ç•™è¨€æ•°æ®...
}
```

### å‘é€ç•™è¨€æ”¹å†™

**åŸä»£ç **ï¼š
```javascript
await addDoc(collection(window.firebaseDB, 'messages'), messageData);
```

**æ–°ä»£ç **ï¼š
```javascript
const result = await window.lafCloud.invoke('message-add', {
  content: message,
  imageUrl: imageUrl
});

if (result.code === 0) {
  alert('å‘å¸ƒæˆåŠŸï¼');
} else {
  alert('å‘å¸ƒå¤±è´¥: ' + result.message);
}
```

---

## âœ… ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•

### 1. æœ¬åœ°æµ‹è¯•
å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼š
```bash
cd /Volumes/chao/AI/xianyu_profit_calculator
python3 -m http.server 8000
```

æ‰“å¼€æµè§ˆå™¨ï¼šhttp://localhost:8000

### 2. æµ‹è¯•æ³¨å†Œ
- è¾“å…¥é‚®ç®±ã€å¯†ç ã€æ˜µç§°
- ç‚¹å‡»æ³¨å†Œ
- æ£€æŸ¥æ˜¯å¦æˆåŠŸ

### 3. æµ‹è¯•ç™»å½•
- è¾“å…¥åˆšæ³¨å†Œçš„é‚®ç®±å¯†ç 
- ç‚¹å‡»ç™»å½•

### 4. æµ‹è¯•ç•™è¨€æ¿
- å‘é€ä¸€æ¡ç•™è¨€
- åˆ·æ–°é¡µé¢æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤º

---

## ğŸš€ ç¬¬å…«æ­¥ï¼šéƒ¨ç½²åˆ° Vercel

### 1. æ¨é€ä»£ç åˆ° GitHub
```bash
git add .
git commit -m "è¿ç§»åˆ° Laf"
git push
```

### 2. Vercel è‡ªåŠ¨éƒ¨ç½²
Vercel ä¼šè‡ªåŠ¨æ£€æµ‹å˜æ›´å¹¶é‡æ–°éƒ¨ç½²

### 3. è·å–ç”Ÿäº§åœ°å€
éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„ç½‘ç«™åœ°å€ï¼š`https://your-project.vercel.app`

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨çš„ç½‘ç«™ï¼š
- âœ… å›½å†…ç”¨æˆ·å¯ç›´æ¥è®¿é—®ï¼ˆæ— éœ€ç¿»å¢™ï¼‰
- âœ… ä½¿ç”¨ Laf æµ‹è¯•åŸŸåï¼ˆxxx.laf.runï¼‰
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- âœ… ç­‰å¤‡æ¡ˆé€šè¿‡åç»‘å®š zaoyoe.com

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q: äº‘å‡½æ•°æŠ¥é”™æ€ä¹ˆåŠï¼Ÿ
**A**: æŸ¥çœ‹ Laf æ§åˆ¶å° â†’ æ—¥å¿—ï¼Œä¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯

### Q: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥ `baseUrl` æ˜¯å¦æ­£ç¡®å¡«å†™

### Q: å‰ç«¯è°ƒç”¨å¤±è´¥ï¼Ÿ
**A**: æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)ï¼ŒæŸ¥çœ‹ Console å’Œ Network

---

**éœ€è¦æˆ‘ç°åœ¨å¸®æ‚¨æ”¹å†™å…·ä½“çš„ä»£ç æ–‡ä»¶å—ï¼Ÿ** ğŸš€
