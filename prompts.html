<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Pro Gallery | Light Poetry</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="prompts-poetry.css">
    <link rel="stylesheet" href="avatar-fix.css?v=4">

    <!-- Prevent flash of wrong theme - Critical CSS -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <!-- Prevent avatar flash - Pre-render from cache -->
    <script>
        (function () {
            try {
                const cached = localStorage.getItem('cached_user_profile');
                if (cached) {
                    const profile = JSON.parse(cached);
                    if (profile && profile.avatarUrl) {
                        // Store for use after DOM ready
                        window.__cachedUserProfile = profile;
                    }
                }
            } catch (e) { /* ignore */ }
        })();
    </script>
    <style>
        /* Critical CSS - Nav instant, content fades in */
        html {
            background-color: #ffffff;
        }

        html[data-theme="dark"] {
            background-color: #0f172a;
        }

        body {
            background-color: inherit;
            margin: 0;
        }

        /* Content areas start hidden, fade in when ready */
        .featured-banner {
            display: none;
            /* Hidden until JS shows it */
        }

        .gallery-container {
            opacity: 0;
            transition: opacity 0.4s ease 0.1s;
        }

        body.loaded .gallery-container {
            opacity: 1;
        }
    </style>
    <!-- Pre-show logged-in buttons if cache exists -->
    <script>
        if (window.__cachedUserProfile) {
            document.write('<style>#profileBtn, #switchAccountBtn, #logoutBtn { display: flex !important; }</style>');
        }
    </script>
</head>

<body>

    <!-- Ambient Light Canvas (Living Background) -->
    <canvas id="ambientCanvas"></canvas>
    <!-- Starry Sky Canvas (Dark Mode Only) -->
    <canvas id="starryCanvas"></canvas>

    <!-- User Avatar Menu -->
    <div class="user-avatar-container" id="userAvatarContainer">
        <button class="user-avatar-btn" id="userAvatarBtn" onclick="toggleAvatarMenu()">
            <script>
                // Inline script to prevent flash - render avatar or icon based on cache
                if (window.__cachedUserProfile && window.__cachedUserProfile.avatarUrl) {
                    // Add onerror to hide broken image and show fallback icon
                    document.write('<img src="' + window.__cachedUserProfile.avatarUrl + '" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.style.display=\'none\';this.parentElement.innerHTML=\'<i class=fa fa-user></i>\';"><i class="fas fa-user" style="display:none;"></i>');
                } else {
                    document.write('<i class="fas fa-user"></i>');
                }
            </script>
        </button>

        <!-- Glassmorphism Dropdown -->
        <div class="avatar-dropdown" id="avatarDropdown">
            <div class="dropdown-header">
                <span class="identity-name">
                    <script>document.write(window.__cachedUserProfile ? (window.__cachedUserProfile.nickname || window.__cachedUserProfile.username || 'Guest') : 'Guest');</script>
                </span>
                <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleTheme(event)">
                    <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
                    <span class="theme-icon moon-icon">üåô</span>
                </button>
            </div>


            <div class="dropdown-actions">
                <!-- Login (guest users only) -->
                <button class="dropdown-action" id="loginBtn" style="display: flex;" onclick="handleGalleryLogin()">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login</span>
                </button>

                <!-- Profile (logged in users) -->
                <button class="dropdown-action" id="profileBtn" style="display: none;" onclick="openGalleryProfile()">
                    <i class="fas fa-user"></i>
                    <span>‰∏™‰∫∫ËµÑÊñô</span>
                </button>
                <!-- Switch Account (logged in users) -->
                <button class="dropdown-action" id="switchAccountBtn" style="display: none;"
                    onclick="switchGalleryAccount()">
                    <i class="fas fa-exchange-alt"></i>
                    <span>ÂàáÊç¢Ë¥¶Êà∑</span>
                </button>
                <!-- Enter Studio (admin only) -->
                <button class="dropdown-action" id="adminStudioBtn" style="display: none;" onclick="enterAdminStudio()">
                    <i class="fas fa-palette"></i>
                    <span>Enter Studio</span>
                </button>
                <!-- Logout (logged in users) -->
                <button class="dropdown-action" id="logoutBtn" style="display: none;" onclick="logoutUser()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation / Categories -->
    <div class="poetry-nav-container">
        <div class="spotlight-overlay"></div>

        <!-- Search Bar (Pinterest-style) -->
        <div class="nav-search-wrapper">
            <div class="nav-search">
                <i class="fas fa-search"></i>
                <input type="text" id="gallerySearch" placeholder="Search prompts..." autocomplete="off">
            </div>

            <!-- Search Dropdown -->
            <div class="search-dropdown" id="searchDropdown">
                <!-- Hot Tags (shown when empty) -->
                <div class="search-hot-tags" id="searchHotTags">
                    <div class="dropdown-section-label">ÁÉ≠Èó®ÊêúÁ¥¢</div>
                    <div class="hot-tags-list" id="hotTagsList">
                        <!-- Dynamically generated -->
                    </div>
                </div>

                <!-- Autocomplete Suggestions (shown when typing) -->
                <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                    <!-- Dynamically generated -->
                </div>
            </div>
        </div>

        <div class="nav-items" id="navItems">
            <!-- Dynamically generated from PROMPTS data -->
        </div>
    </div>

    <!-- Featured Banner -->
    <section class="featured-banner" id="featuredBanner">
        <div class="featured-image-container">
            <img id="featuredImage" src="" alt="Featured Artwork" loading="eager">
            <div class="featured-overlay"></div>
        </div>
        <div class="featured-content">
            <span class="featured-label">‚ú¶ Featured</span>
            <h2 class="featured-title" id="featuredTitle"></h2>
            <p class="featured-description" id="featuredDescription"></p>
        </div>
    </section>

    <!-- Gallery Grid -->
    <div class="gallery-container">
        <!-- Content injected by JS -->
    </div>

    <!-- Detail Modal -->
    <div id="promptModal" class="poetry-modal">
        <button class="close-modal-btn" onclick="closePromptModal()">
            <i class="fas fa-times"></i>
        </button>

        <div class="modal-inner">
            <div class="modal-image-col">
                <img id="modalImg" src="" alt="Prompt Visual">

                <!-- Image Navigation -->
                <button id="modalImgNavLeft" class="modal-img-nav left" onclick="navigateModalImage('prev')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button id="modalImgNavRight" class="modal-img-nav right" onclick="navigateModalImage('next')">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div id="modalImgCounter" class="modal-img-counter">1 / 1</div>

                <!-- Target Area for Prompt Docking (FLIP Animation Destination) -->
                <div id="promptDockTarget" class="prompt-dock-target"></div>
            </div>

            <div class="modal-content-col">
                <div class="modal-header">
                    <div id="modalTitle" class="modal-title-large">Title</div>
                    <div id="modalTags" class="modal-meta">
                        <!-- Tags injected here -->
                    </div>
                </div>

                <p id="modalDesc" class="modal-description">
                    Description goes here...
                </p>

                <!-- Prompt Area (FLIP Animation Source) -->
                <div id="promptArea" class="prompt-area">
                    <div class="prompt-content-wrapper">
                        <span class="prompt-label">Prompt</span>
                        <div id="modalPromptText" class="prompt-text blur-masked">
                            Loading prompt...
                        </div>
                    </div>

                    <!-- Action Bar: Unlock & Comment Trigger -->
                    <div class="prompt-action-bar">
                        <div class="action-left">
                            <button id="unlockPromptBtn" class="unlock-btn" onclick="handleUnlockPrompt()">
                                <i class="fas fa-gem"></i> 10
                            </button>
                        </div>
                        <div class="action-right">
                            <button id="commentTriggerBtn" class="comment-trigger-btn" onclick="toggleCommentMode()">
                                <i class="fas fa-comment-dots"></i>
                                <span id="commentCountBadge" class="comment-count">0</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Comment Section (Initially Hidden) -->
                <div id="commentSection" class="comment-section">
                    <!-- Comment Header: Title + Sorting -->
                    <div class="comment-header">
                        <div class="comment-header-title" id="commentSectionTitle">
                            View all
                        </div>
                        <div class="comment-sort-wrapper">
                            <button class="comment-sort-btn" id="commentSortBtn">
                                <span id="currentSortLabel">Top</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="comment-sort-dropdown" id="commentSortDropdown">
                                <div class="sort-option active" data-sort="top">üî• Top</div>
                                <div class="sort-option" data-sort="newest">Newest</div>
                                <div class="sort-option" data-sort="oldest">Oldest</div>
                            </div>
                        </div>
                    </div>

                    <div class="comment-list" id="commentList">
                        <!-- Comments injected here -->
                    </div>

                    <div class="comment-input-area">
                        <textarea id="commentInput" placeholder="Add a comment..." rows="1"
                            onkeydown="handleCommentKeydown(event)" oninput="autoExpandTextarea(this)"></textarea>

                        <!-- Hidden file input -->
                        <input type="file" id="commentImageUpload" accept="image/*" style="display: none;">

                        <!-- Upload button -->
                        <button id="commentUploadBtn" class="comment-upload-btn" title="Attach image">
                            <i class="fas fa-image"></i>
                        </button>



                        <!-- ÂèëÈÄÅÊåâÈíÆ -->
                        <!-- ÂèëÈÄÅÊåâÈíÆ (Â∞èÈ£ûÊú∫ÂõæÊ†á) -->
                        <button id="sendCommentBtn" class="send-comment-btn" onclick="submitComment()" title="Send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer Footer -->
    <footer class="disclaimer-footer">
        <div class="disclaimer-content">
            <p class="disclaimer-title">‚ú¶ ÂÖçË¥£Â£∞Êòé Disclaimer</p>
            <p class="disclaimer-text">
                Êú¨È°µÈù¢Â±ïÁ§∫ÁöÑÂõæÁâáÂèäÊèêÁ§∫ËØçÂùáÊù•Ê∫ê‰∫é‰∫íËÅîÁΩëÂÖ¨ÂºÄÂàÜ‰∫´Ôºå‰ªÖ‰æõÂ≠¶‰π†ÂíåÂèÇËÄÉ‰ΩøÁî®„ÄÇ
                Â¶ÇÊúâ‰æµÊùÉÔºåËØ∑ËÅîÁ≥ªÂà†Èô§„ÄÇÊâÄÊúâÂÜÖÂÆπÁâàÊùÉÂΩíÂéü‰ΩúËÄÖÊâÄÊúâ„ÄÇ
            </p>
            <p class="disclaimer-text-en">
                Images and prompts displayed on this page are collected from public internet sources for educational
                purposes only.
                If any content infringes your rights, please contact us for removal. All rights belong to original
                creators.
            </p>
        </div>
    </footer>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="admin-login-modal">
        <div class="admin-login-content">
            <button class="admin-login-close" onclick="closeAdminLoginModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="admin-login-header">
                <i class="fas fa-palette"></i>
                <h2>Admin Access</h2>
                <p>Sign in to access the Studio</p>
            </div>
            <button class="google-login-btn" onclick="handleGoogleLogin()">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                <span>Continue with Google</span>
            </button>
            <p class="admin-login-note">Only administrators can access the Studio</p>
        </div>
    </div>

    <style>
        /* Admin Login Modal Styles */
        .admin-login-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        .admin-login-modal.active {
            display: flex;
        }

        .admin-login-content {
            background: var(--card-bg, #ffffff);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 380px;
            text-align: center;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        [data-theme="dark"] .admin-login-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-login-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-muted, #64748b);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .admin-login-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary, #1e293b);
        }

        [data-theme="dark"] .admin-login-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .admin-login-header {
            margin-bottom: 30px;
        }

        .admin-login-header i {
            font-size: 48px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
        }

        .admin-login-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            margin: 0 0 8px 0;
            color: var(--text-primary, #1e293b);
        }

        [data-theme="dark"] .admin-login-header h2 {
            color: #f8fafc;
        }

        .admin-login-header p {
            color: var(--text-muted, #64748b);
            margin: 0;
            font-size: 14px;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 24px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-login-btn:hover {
            background: #f8fafc;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .google-login-btn {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #f8fafc;
        }

        [data-theme="dark"] .google-login-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .admin-login-note {
            margin-top: 20px;
            font-size: 12px;
            color: var(--text-muted, #64748b);
        }
    </style>

    <!-- Scripts -->
    <!-- Supabase Client (CDN for browser) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Day.js for relative time display -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>

    <script>
        // Initialize Supabase client for browser
        const SUPABASE_URL = 'https://mmkugdibsaeoevliebzk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_lwkiF-sQ80z8e9oMcejFPQ_j7oezjcF';
        window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase browser client initialized');

        // Initialize Day.js
        dayjs.extend(dayjs_plugin_relativeTime);
        dayjs.locale('zh-cn');
        console.log('Day.js initialized with zh-cn locale');
    </script>
    <script src="prompts-data.js"></script>
    <script src="starry-sky.js"></script>
    <script src="prompts-poetry.js"></script>
    <script>
        // Reveal page after content is ready
        document.body.classList.add('loaded');
    </script>

</body>

</html>