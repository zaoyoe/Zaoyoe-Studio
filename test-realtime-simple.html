<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>å¿«é€Ÿæµ‹è¯• Realtime</title>
    <style>
        body {
            font-family: system-ui;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>

<body>
    <h1>ğŸ§ª Realtime å¿«é€Ÿæµ‹è¯•</h1>
    <div id="status"></div>
    <button onclick="testConnection()">å¼€å§‹æµ‹è¯•</button>
    <div class="log" id="log"></div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://mmkugdibsaeoevliebzk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_lwkiF-sQ80z8e9oMcejFPQ_j7oezjcF';

        let client, channel;

        function log(msg, isError = false) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
        }

        function showStatus(msg, success = true) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${success ? 'success' : 'error'}`;
            statusDiv.textContent = msg;
        }

        async function testConnection() {
            try {
                log('åˆå§‹åŒ– Supabase Client...');
                client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                log('âœ… Client åˆ›å»ºæˆåŠŸ');

                // Test auth
                const { data: { user } } = await client.auth.getUser();
                log(user ? `å½“å‰ç”¨æˆ·: ${user.email}` : 'æœªç™»å½•ï¼ˆæ¸¸å®¢æ¨¡å¼ï¼‰');

                // Create channel
                log('åˆ›å»º Realtime Channel...');
                channel = client
                    .channel('test-comments')
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'prompt_comments' },
                        (payload) => {
                            log(`ğŸ‰ æ”¶åˆ°æ–°è¯„è®ºäº‹ä»¶ï¼ID: ${payload.new.id}`, false);
                            log(`å†…å®¹: ${payload.new.content}`);
                            showStatus('âœ… Realtime å·¥ä½œæ­£å¸¸ï¼æ”¶åˆ°äº†æ–°è¯„è®ºé€šçŸ¥', true);
                        }
                    )
                    .subscribe((status) => {
                        log(`è®¢é˜…çŠ¶æ€: ${status}`);

                        if (status === 'SUBSCRIBED') {
                            showStatus('âœ… æˆåŠŸè®¢é˜…ï¼ç°åœ¨åœ¨å…¶ä»–æµè§ˆå™¨å‘é€è¯„è®ºæµ‹è¯•', true);
                            log('âœ… è®¢é˜…æˆåŠŸï¼ç­‰å¾…æ–°è¯„è®º...');
                        } else if (status === 'CHANNEL_ERROR') {
                            showStatus('âŒ è®¢é˜…å¤±è´¥ï¼è¯·æ£€æŸ¥é…ç½®', false);
                            log('âŒ Channel é”™è¯¯', true);
                        }
                    });

                log('æµ‹è¯•å¯åŠ¨å®Œæˆã€‚è¯·åœ¨å…¶ä»–æµè§ˆå™¨çª—å£å‘é€è¯„è®ºã€‚');

            } catch (err) {
                log(`âŒ é”™è¯¯: ${err.message}`, true);
                showStatus(`âŒ æµ‹è¯•å¤±è´¥: ${err.message}`, false);
            }
        }

        // Auto-test on load
        window.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>

</html>