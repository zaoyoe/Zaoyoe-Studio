<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Studio | Prompt Gallery</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="prompts-poetry.css">
    <link rel="stylesheet" href="admin-studio.css?v=3">

    <!-- Prevent flash of wrong theme -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        })();
    </script>
</head>

<body>
    <!-- Ambient Light Canvas -->
    <canvas id="ambientCanvas"></canvas>

    <!-- Header -->
    <header class="studio-header">
        <a href="prompts.html" class="back-link">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Gallery</span>
        </a>
        <h1 class="studio-title">
            <i class="fas fa-palette"></i>
            Admin Studio
        </h1>
        <div class="header-right">
            <div id="apiKeySelector" class="api-key-selector">
                <!-- Rendered by JavaScript -->
            </div>
            <div class="studio-status" id="studioStatus">
                <span class="status-dot"></span>
                <span class="status-text">Ready</span>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="admin-tabs">
        <button class="admin-tab active" data-view="create" onclick="switchView('create')">Create</button>
        <button class="admin-tab" data-view="manage" onclick="switchView('manage')">Manage</button>
    </nav>

    <!-- Main Content -->
    <!-- Starry Background for Dark Mode -->
    <canvas id="starryCanvas"></canvas>

    <div class="studio-main">
        <!-- CREATE VIEW -->
        <div id="view-create" class="view-section active">
            <!-- Batch Edit Switcher (only visible in batch edit mode) -->
            <div class="batch-edit-bar" id="batchEditBar" style="display: none;">

                <div class="batch-edit-dropdown" id="batchEditDropdown">
                    <button class="batch-edit-current" id="batchEditCurrent">
                        <span class="current-title">选择提示词...</span>
                        <span class="current-index">(0/0)</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="batch-edit-menu" id="batchEditMenu">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                <button class="batch-edit-close" id="batchEditClose" title="退出批量编辑">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- Upload Section -->
            <section class="upload-section glass-panel">
                <h2 class="section-title">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload Images
                </h2>

                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <p class="upload-text">Drag & drop images here</p>
                    <p class="upload-subtext">or click to browse</p>
                    <input type="file" id="fileInput" multiple accept="image/*" hidden>
                </div>

                <!-- Image Preview Grid -->
                <div class="preview-grid" id="previewGrid">
                    <!-- Dynamically populated -->
                </div>
            </section>

            <!-- AI Analysis Section -->
            <section class="analysis-section glass-panel">
                <h2 class="section-title">
                    <i class="fas fa-robot"></i>
                    AI Analysis
                    <button class="analyze-btn" id="analyzeBtn" disabled>Analyze</button>
                </h2>

                <!-- Loading State - Elegant Neural Animation -->
                <div class="analysis-loading" id="analysisLoading" style="display: none;">
                    <div class="neural-loader">
                        <div class="neural-dot"></div>
                        <div class="neural-dot"></div>
                        <div class="neural-dot"></div>
                        <div class="neural-dot"></div>
                        <div class="neural-dot"></div>
                    </div>
                </div>

                <!-- Results Form -->
                <form class="prompt-form" id="promptForm" style="display: none;">
                    <!-- Title -->
                    <div class="form-group">
                        <label for="promptTitle">
                            <i class="fas fa-heading"></i>
                            Title
                            <span class="ai-badge">AI Generated</span>
                            <!-- Last Edited Info (shown only in edit mode) -->
                            <span class="last-edited-info" id="lastEditedInfo" style="display: none;">
                                <i class="fas fa-clock"></i>
                                <time id="lastEditedTime"></time>
                            </span>
                        </label>
                        <input type="text" id="promptTitle" placeholder="Enter prompt title...">
                    </div>

                    <!-- Category -->
                    <div class="form-group">
                        <label for="promptCategory">
                            <i class="fas fa-folder"></i>
                            Category
                            <span class="ai-badge">AI Detected</span>
                        </label>
                        <!-- Custom Dropdown -->
                        <div class="custom-select" id="categoryDropdown">
                            <input type="hidden" id="promptCategory" name="promptCategory" value="">
                            <div class="select-display" id="categoryDisplay">
                                <span class="select-text">Select category...</span>
                                <i class="fas fa-chevron-down select-arrow"></i>
                            </div>
                            <div class="select-options" id="categoryOptions">
                                <div class="select-option" data-value="">Select category...</div>
                                <div class="select-option" data-value="Photography">Photography</div>
                                <div class="select-option" data-value="Illustration">Illustration</div>
                                <div class="select-option" data-value="3D Art">3D Art</div>
                                <div class="select-option" data-value="Miniature">Miniature</div>
                                <div class="select-option" data-value="Creative">Creative</div>
                                <div class="select-option" data-value="Animation">Animation</div>
                            </div>
                        </div>
                    </div>

                    <!-- Prompt Text -->
                    <div class="form-group">
                        <label for="promptText">
                            <i class="fas fa-terminal"></i>
                            Prompt Text
                        </label>
                        <textarea id="promptText" rows="6"
                            placeholder="Enter the prompt text used to generate this image..."></textarea>
                    </div>

                    <!-- Description (Hidden - still analyzed in background) -->
                    <div class="form-group" style="display: none;">
                        <label for="promptDescription">
                            <i class="fas fa-align-left"></i>
                            Description
                            <span class="ai-badge">AI Generated</span>
                        </label>
                        <textarea id="promptDescription" rows="3" placeholder="Brief description..."></textarea>
                    </div>

                    <!-- AI Tags Display (Hidden - still analyzed in background) -->
                    <div class="form-group" style="display: none;">
                        <label>
                            <i class="fas fa-tags"></i>
                            AI Tags
                            <span class="ai-badge">Auto-generated</span>
                        </label>
                        <div class="tags-container">
                            <div class="tag-category">
                                <span class="tag-label">Objects:</span>
                                <div class="tag-list" id="tagObjects"></div>
                            </div>
                            <div class="tag-category">
                                <span class="tag-label">Scenes:</span>
                                <div class="tag-list" id="tagScenes"></div>
                            </div>
                            <div class="tag-category">
                                <span class="tag-label">Styles:</span>
                                <div class="tag-list" id="tagStyles"></div>
                            </div>
                            <div class="tag-category">
                                <span class="tag-label">Mood:</span>
                                <div class="tag-list" id="tagMood"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Dominant Colors (Hidden - still analyzed in background) -->
                    <div class="form-group" style="display: none;">
                        <label>
                            <i class="fas fa-palette"></i>
                            Dominant Colors
                            <span class="ai-badge">Extracted</span>
                        </label>
                        <div class="color-swatches" id="colorSwatches"></div>
                    </div>

                    <!-- Submit Button -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="resetForm()">
                            <i class="fas fa-undo"></i>
                            Reset
                        </button>
                        <button type="submit" class="btn-primary" id="saveBtn">
                            <span class="btn-text">
                                <i class="fas fa-save"></i>
                                Save to Gallery
                            </span>
                            <div class="dot-matrix-container">
                                <div class="dot-matrix" id="dotMatrix">
                                    <!-- 30 dots: 10 columns x 3 rows -->
                                </div>
                            </div>
                        </button>
                    </div>
                </form>
            </section>
        </div>
        <!-- END CREATE VIEW -->

        <!-- MANAGE VIEW -->
        <div id="view-manage" class="view-section">
            <!-- Search Toolbar -->
            <div class="manage-toolbar">
                <!-- Search Bar with Dropdown Wrapper -->
                <div class="admin-search-wrapper">
                    <div class="admin-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="adminSearchInput" placeholder="Search prompts..." autocomplete="off">
                    </div>
                    <!-- Search Dropdown -->
                    <div class="search-dropdown" id="adminSearchDropdown">
                        <!-- Autocomplete Suggestions (shown when typing) -->
                        <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                            <!-- Dynamically generated -->
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <!-- Category Filter - Custom Dropdown -->
                    <div class="custom-select filter-custom-select" id="categoryFilterDropdown">
                        <input type="hidden" id="categoryFilter" name="categoryFilter" value="">
                        <div class="select-display">
                            <span class="select-text">All</span>
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                        <div class="select-options">
                            <div class="select-option selected" data-value="">All</div>
                            <div class="select-option" data-value="Photography">Photography</div>
                            <div class="select-option" data-value="3D Art">3D Art</div>
                            <div class="select-option" data-value="Illustration">Illustration</div>
                            <div class="select-option" data-value="Creative">Creative</div>
                            <div class="select-option" data-value="Miniature">Miniature</div>
                            <div class="select-option" data-value="Animation">Animation</div>
                        </div>
                    </div>
                    <!-- Date Filter - Custom Dropdown -->
                    <div class="custom-select filter-custom-select" id="dateFilterDropdown">
                        <input type="hidden" id="dateFilter" name="dateFilter" value="">
                        <div class="select-display">
                            <span class="select-text">All</span>
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                        <div class="select-options">
                            <div class="select-option selected" data-value="">All</div>
                            <div class="select-option" data-value="today">Today</div>
                            <div class="select-option" data-value="week">This Week</div>
                            <div class="select-option" data-value="month">This Month</div>
                        </div>
                    </div>
                </div>
                <!-- Batch Actions -->
                <div class="batch-actions-wrapper" id="batchActionsWrapper">
                    <button class="batch-btn" id="selectModeBtn" title="选择模式">
                        <i class="fas fa-check-square"></i>
                    </button>
                    <div class="batch-menu-container" id="batchMenuContainer" style="display: none;">
                        <button class="batch-btn" id="batchMenuTrigger" title="批量操作">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div class="batch-dropdown-menu" id="batchDropdownMenu">
                            <div class="batch-menu-item" id="selectAllBtn">
                                <i class="fas fa-check-double"></i>
                                <span>全选</span>
                            </div>
                            <div class="batch-menu-item" id="batchEditMenuItem">
                                <i class="fas fa-edit"></i>
                                <span>批量编辑</span>
                            </div>
                            <div class="batch-menu-item" id="batchReanalyzeMenuItem">
                                <i class="fas fa-sync-alt"></i>
                                <span>批量重分析</span>
                            </div>
                            <div class="batch-menu-item" id="analyzeUntaggedMenuItem">
                                <i class="fas fa-tags"></i>
                                <span>补充标签</span>
                            </div>
                            <div class="batch-menu-divider"></div>
                            <div class="batch-menu-item danger" id="batchDeleteMenuItem">
                                <i class="fas fa-trash-alt"></i>
                                <span>批量删除</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="prompt-count" id="promptCountWrapper" style="display: none;">
                    <span class="select-count">已选 <span id="selectedCount">0</span> 项</span>
                </div>
            </div>
            <div class="admin-grid" id="adminGrid">
                <!-- Dynamically loaded -->
            </div>
        </div>
        <!-- END MANAGE VIEW -->
        </main>

        <!-- Batch Progress Modal -->
        <div class="batch-modal-overlay" id="batchProgressOverlay" style="display: none;">
            <div class="batch-modal">
                <h3 class="batch-modal-title" id="batchModalTitle">批量重分析</h3>
                <div class="batch-modal-body">
                    <p class="batch-current-item" id="batchCurrentItem">正在分析...</p>
                    <div class="batch-progress-bar">
                        <div class="batch-progress-fill" id="batchProgressFill"></div>
                    </div>
                    <p class="batch-progress-text" id="batchProgressText">0/0 (0%)</p>
                    <p class="batch-time-remaining" id="batchTimeRemaining">预计剩余: --</p>
                </div>
                <div class="batch-modal-actions">
                    <button class="btn-secondary" id="batchPauseBtn">
                        <i class="fas fa-pause"></i> 暂停
                    </button>
                    <button class="btn-danger" id="batchCancelBtn">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="batch-modal-overlay" id="deleteConfirmOverlay" style="display: none;">
            <div class="batch-modal confirm-modal">
                <h3 class="batch-modal-title">⚠️ 确认删除</h3>
                <div class="batch-modal-body">
                    <p id="deleteConfirmText">确定要删除选中的 0 个提示词吗？</p>
                    <p class="warn-text">此操作无法撤销！</p>
                </div>
                <div class="batch-modal-actions">
                    <button class="btn-secondary" id="deleteConfirmCancel">取消</button>
                    <button class="btn-danger" id="deleteConfirmOk">确认删除</button>
                </div>
            </div>
        </div>

        <!-- Image Preview Lightbox -->
        <div class="lightbox-overlay" id="lightboxOverlay" style="display: none;">
            <button class="lightbox-close" id="lightboxClose"><i class="fas fa-times"></i></button>
            <img class="lightbox-image" id="lightboxImage" src="" alt="Preview">
        </div>

        <!-- Crop Modal -->
        <div class="batch-modal-overlay" id="cropModalOverlay" style="display: none;">
            <div class="batch-modal crop-modal">
                <h3 class="batch-modal-title">✂️ 裁切图片</h3>
                <div class="crop-container" id="cropContainer">
                    <img id="cropImage" src="" alt="Crop">
                </div>
                <div class="batch-modal-actions">
                    <button class="btn-secondary" id="cropCancel">取消</button>
                    <button class="btn-primary" id="cropApply">应用裁切</button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script>
            // Initialize Supabase client
            const SUPABASE_URL = 'https://mmkugdibsaeoevliebzk.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_lwkiF-sQ80z8e9oMcejFPQ_j7oezjcF';
            window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        </script>
        <script src="admin-studio.js"></script>
</body>

</html>