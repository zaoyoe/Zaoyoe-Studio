<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrate Prompts to Supabase</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0f172a;
            color: #f8fafc;
        }

        h1 {
            color: #9b5de5;
        }

        .button {
            background: linear-gradient(135deg, #9b5de5 0%, #f15bb5 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
        }

        .button:hover {
            opacity: 0.9;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #log {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-line {
            margin: 5px 0;
        }

        .success {
            color: #10b981;
        }

        .error {
            color: #ef4444;
        }

        .info {
            color: #60a5fa;
        }

        .warning {
            color: #f59e0b;
        }
    </style>
</head>

<body>
    <h1>ðŸ”„ Migrate Static Prompts to Supabase</h1>
    <p>This will copy all prompts from <code>prompts-data.js</code> to your Supabase database.</p>

    <button class="button" id="migrateBtn" onclick="startMigration()">Start Migration</button>

    <div id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="prompts-data.js"></script>
    <script>
        // Initialize Supabase (using same credentials as admin-studio.html)
        const SUPABASE_URL = 'https://mmkugdibsaeoevliebzk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_lwkiF-sQ80z8e9oMcejFPQ_j7oezjcF';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = message;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function startMigration() {
            const btn = document.getElementById('migrateBtn');
            btn.disabled = true;
            btn.textContent = 'Migrating...';

            log('ðŸš€ Starting migration...', 'info');
            log(`ðŸ“„ Found ${PROMPTS.length} prompts in prompts-data.js`, 'info');

            try {
                // Check if prompts already exist
                const { count: existingCount } = await supabaseClient
                    .from('prompts')
                    .select('*', { count: 'exact', head: true });

                log(`ðŸ“Š Current database has ${existingCount} prompts`, 'info');

                // Transform data to match database schema
                const dataToInsert = PROMPTS.map(p => ({
                    title: p.title,
                    tags: p.tags || [],
                    description: p.description || null,
                    prompt_text: p.prompt || null,  // Note: prompt_text, not prompt
                    images: p.images || [],
                    dominant_colors: p.dominantColors || [],
                    ai_tags: p.aiTags || null
                }));

                log(`ðŸ”„ Inserting ${dataToInsert.length} prompts...`, 'info');

                // Insert in batches of 50 to avoid timeout
                const batchSize = 50;
                let inserted = 0;

                for (let i = 0; i < dataToInsert.length; i += batchSize) {
                    const batch = dataToInsert.slice(i, i + batchSize);
                    const { data, error } = await supabaseClient
                        .from('prompts')
                        .insert(batch)
                        .select();

                    if (error) {
                        throw error;
                    }

                    inserted += batch.length;
                    log(`âœ… Inserted batch ${Math.floor(i / batchSize) + 1}: ${batch.length} prompts (Total: ${inserted}/${dataToInsert.length})`, 'success');
                }

                // Verify final count
                const { count: finalCount } = await supabaseClient
                    .from('prompts')
                    .select('*', { count: 'exact', head: true });

                log(`ðŸŽ‰ Migration complete!`, 'success');
                log(`ðŸ“Š Database now has ${finalCount} total prompts`, 'success');

                btn.textContent = 'âœ… Migration Complete!';
                btn.style.background = '#10b981';

            } catch (error) {
                log(`âŒ Migration failed: ${error.message}`, 'error');
                console.error('Full error:', error);
                btn.disabled = false;
                btn.textContent = 'Retry Migration';
            }
        }
    </script>
</body>

</html>